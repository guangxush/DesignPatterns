## 高可用架构

网站的可用性描述网站可有效访问的特性

### 网站可用性的度量

网页呈现在用户面前会有很多环节，中间一些环节出了问题都可能导致网站不可用，比如DNS被劫持、CDN服务挂掉
、网站可能会宕机、网站交换机可能会失效、硬盘可能损坏、网卡可能松掉、机房会停电、空调会失灵、程序会有Bug、黑客会劫持
、促销引起大量访问、第三方合作伙伴服务不可用等等都会影响网站的可用性。

#### 网站可用性度量

业界通常用4个9衡量网站的可用性，比如QQ服务99.99%，意味着一年有最多53分钟不可用。

网站不可用时间（故障时间）=故障修复时间点-故障发现（报告）时间点

网站年度可用性指=（1-网站不可用时间/年度总时间）*100%

#### 网站可用性考核

故障分计算

![](../../image/errorscore.png)

故障发现流程：客户或者监控报告发现故障、提交故障给相关部门接口、故障着手处理、故障处理完毕归档、确认故障归属计入绩效考核

### 高可用网站架构

昂贵的硬件设备：IBM小型机、中型机及专有的操作系统；Oracle数据库；EMC存储设备
一般的互联网公司采用PC级服务器、开源数据库和操作系统，这些廉价的设备降低了可用性。


既然硬件故障是常态，那么要通过软件架构对数据和服务进行冗余备份及失效转移，一旦某些服务器宕机，就切换到其他可用的服务器上，如果磁盘损坏，则从备份磁盘中读取数据

分层架构：应用层、服务层、数据层，各层之间具有相对独立性

大型网站的分层架构以及物理服务器的分布式部署使得位于不同层次的服务器具有不同的可用性，关闭服务或者服务器宕机时产生的影响也不同。

位于应用层的服务器通过负载均衡设备将一组服务器组成一个集群提供对外服务，通过检测心跳的方式监控服务器的运行状态，如果不可用将其从列表中剔除，使得整个集群可用。

位于服务层的服务器通过集群的方式实现高可用，通过分布式服务调用框架访问，实现软件的负载均衡，并通过注册中心进行心跳检测，发现服务不可用时，立即通知客户端修改服务访问列表，剔除不可用的服务器。

位于数据层的服务器由于存储着数据，为了保证服务器宕机时数据不丢失，数据访问不间断，需要实现数据的同步复制，实现数据的冗余备份，当服务器宕机时，切换到备份服务器上。

网站升级频率较高，有时一周发布多次，每次网站发布需要关闭服务，重新部署系统，相当于整个服务器宕机，所以需要考虑升级发布时如何提高可用性。


### 高可用的应用

应用层也叫业务逻辑层，显著的特点是无状态，指的是应用服务器不保存业务的上下文信息，仅根据每次请求提交的数据进行业务逻辑处理，多个服务器实例之间完全对等，提交到任意服务器结构都一样

#### 通过负载均衡进行无状态服务的失效转移

负载均衡是在业务量和数据量较高的情况下，当单台服务器不足以承担所有的负载压力时，通过负载均衡手段将流量和数据分摊到一个集群组成的多台服务器上，提高整体的负载处理能力。

![](../../image/loadbalance.png)

#### 应用服务器集群的Session管理

虽然高可用架构主要基于无状态的特性，但是业务中比如购物车、购买记录、购买请求都是有状态的，社交类网站当前用户的登陆也是有状态的。

Web应用中将多次请求修改使用的上下文对象称为会话（Session）,单机情况下，Session可由部署在服务器伤的Web容器管理。
由于负载均衡设备可能将请求分发到任意一个服务器上，所以保证每次请求能够获取到正确的Session比单机要复杂。

Session的管理手段有以下几种：

1. Session复制

集群中几台服务器之间同步Session对象，这样任何一台机器宕机都不会引起Session数据丢失。
这种方案虽然简单但是，当集群规模较大时，系统负担太大，Session复制需要占用大量的通信资源，甚至会出现内存不够的情况。

![](../../image/sessioncopy.png)


2. Session绑定

Session绑定可以通过负载均衡的原地址Hash算法实现，负载均衡将同一IP的请求分发到固定的一台服务器上，因此负载均衡服务器必须工作在HTTP层。

![](../../image/sessionbind.png)


但是玩意某台服务器宕机就会导致该机器上的Session不存在，无法完成业务，因此这种方法不可靠。


3. 利用Cookie记录Session

早期的企业应用中使用CS架构，一种管理Session的方式是将Session记录在客户端，每次请求时，服务器处理完请求之后再将修改后的Session响应给客户端。


![](../../image/cookiesavesession.png)

但这种方法的限制是：可能受Cookie大小的限制，能记录的信息有限；每次响应都要传Cookie，影响性能；如果用户客户端关闭Cookie每次访问就不正常。
但是这种方法仍然是简单易用的一种方式。


4. Session服务器

利用独立部署的Session服务器统一管理Session, 应用服务器每次读写Session的时候，都访问Session服务器。
将应用服务器分为有状态的和无状态的，对于有状态的可以利用分布式缓存、数据库等使其符合Session的存储和访问要求
如果业务场景对Session管理有着比较高的要求，比如单点登录SSO等，需要开发专门的Session服务管理平台。


![](../../image/sessionserver.png)


### 高可用服务

高可用服务策略：

1. 分级管理

运维上将服务器进行分级管理，核心应用和服务使用更好的硬件，不同服务进行隔离，避免故障连锁反应。


2. 超时设置

由于服务器宕机或者线程死锁导致的调用失去响应，同时还占用应用程序资源，不利于及时将访问请求转移到正常服务器上。

所以一旦超过时间，通信框架应该抛出异常，或者根据调度策略选择重试或者请求转移到其他服务器上。


3. 异步调用

应用对服务的调用通过消息队列异步完成，避免一个服务失败导致整个应用请求失败。
比如用户请求A会顺序调用B存储，C发邮件的功能，如果同步调用会导致C服务失败的时候影响其他服务进行，
采用消息队列，B和C服务分别对消息进行消费，C发送失败不会影响其他服务阻塞，只是C服务晚一点进行而已。


4. 服务降级

网站高峰期可能存在大量并发调用导致性能下降，甚至宕机，为了保证核心服务进行，可以对服务进行降级。

降级操作有：拒绝服务，拒绝低优先级应用的调用，减少服务调用的并发数目，节约资源。关闭功能：对一些评价、确认收获等功能进行关闭，保证其他服务顺利进行。



5. 幂等性设计

当调用服务失败时，会将调用请求重新发送给其他服务器，比如服务已经处理成功，但是网络问题用户没有收到反馈，这时候重新提交请求会导致重复调用，比如转账。

因此必须在服务层保证重复调用服务和调用一次的结果相同，这就是幂等性。

可以通过交易编号等信息进行有效性验证，只有有效的操作才能继续进行。

### 高可用数据

保证高可用数据的手段是数据备份和失效转移机制。数据备份是保证多个数据副本，任意副本的丢失不会导致数据的永久丢失，从而实现数据的持久化。
失效转移是保证当一个副本不可用时，可以快速的切换访问数据的其他副本，保证可用性。


注意缓存服务不是出局的存储服务，缓存服务器宕机引起的缓存数据丢失可导致服务器压力过高，这种可以通过其他手段进行，而不是提高缓存服务本身的高可用
可以通过苦熬大缓存服务器集群，使得整个网站共享同一个分布式缓存集群，单独的产品和应用不需要不是自己的缓存服务器，只需要像共享缓存集群中申请资源即可。
缓存服务器通过逻辑或者物理分区将缓存部署在不同的机器上，任何一台服务器宕机引起的缓存失效只会影响缓存数据的一小部分。


#### CAP理论

为了保证高可用可能会牺牲数据一致性。

1. 数据持久性 Patition Tolerance

保证数据永久存储，任何情况不会出现数据丢失的问题，需要将数据备份一个或者多个副本，存放在不同的物理设备上，当一个存储故障时，不会丢失

2. 数据可访问性 Availiblity

多份数据备份分别存放在不同的存储设备上，如果一个数据设备损坏，需要将数据访问切换到另一个设备上，这个过程如果不能很快完成或者需要一段时间停止用户请求，那么数据是不可访问的

3. 数据一致性 Consistency

数据在多份副本的情况下，如果网络、服务器故障，会导致部分备份写入成功，部分失败，导致副本之间的数据不一致。


![](../../image/cap.png)

CAP理论是一个数据服务的存储系统不能同时满足C、A、P这三个条件


数据一致性分类：

1. 数据强一致性

个个副本在物理存储介质中总是一致的，数据更新和操作结果和操作响应也是一致的，操作响应通知更新失败时，那么数据一定没有更新

2. 数据用户一致

数据在物理存储中各个副本可能是不一致的，但是终端用户访问时，通过纠错和校验机制，可以确定一个一致且正确的结果返回给用户

3. 数据最终一致性

物理存储数据可能不一致，终端用户访问也可能不一致，但是系统经过一段时间自我恢复和纠正，数据会达到一致。


#### 数据备份

冷备份：简单和廉价，成本和技术难度低，缺点是不能保证数据最终一致，数据是定期复制，所以备份数据可能会比较落后，会导致一段时间的数据不可用

热备份：异步热备份和同步热备份

异步方式是指多份数据副本的写入操作是异步完成的，应用数据收到数据服务系统的写操作响应成功时，只写入成功了一份，存储系统会异步写入其他的副本Master异步写入其他Slave

![](../../image/hotcopy.png)

同步方式是指多份数据副本写入操作同步完成，应用程序收到响应时，所有的副本已经写入成功。（但是当数据写失败的时候，可能有些副本写入成功了，这时候需要等待所有的都写入成功才能返回成功消息）

这种情况下，存储服务器没有主从之分，完全对层，便于管理和维护，性能是最慢的存储服务器的延迟时间。

![](../../image/hotcopy1.png)


一些NoSQL数据库更是将数据备份机制作为产品的主要功能之一

关系数据库主要采用Master-Slave同步机制，还可以改善读写性能，写入只用Master，读尽量用Slave

#### 失效转移

如果又一个服务器宕机，那么需要将读写操作路由到其他服务器，保证数据访问不会失败，这是失效转移
主要有三部分组成，失效确认、访问转移、数据恢复。


1. 失效确认

通过心跳检测或者应用程序访问失败报告

![](../../image/outconfirm.png)


2. 访问转移

确认某台数据存储服务宕机之后，需要将数据读写重新路由到其他机器上（主从结构的服务器存储一般是对等的）。如果存储是不对等的，那么需要重新计算路由，选择存储服务器。

3. 数据恢复

因为某台服务器宕机，所以数据存储的副本数目会减少，必须将副本的数据恢复到设定的值，否在再次出现故障会导致无法转移。

### 高可用网站软件的质量保证

#### 网站发布

使用脚本发布，每次关闭服务器集群中的一小部分，发布完成后立即可以访问

![](../../image/deployservice.png)


#### 自动化测试

代码上线之前需要严格的测试，有时需要对网站功能进行全面的回归测试，一键部署自动化测试，生成报告


#### 预发布验证

一般是先发布到预发布机器上进行验证，等执行一些业务没有问题之后再正式发布

![](../../image/predeploy.png)

因为预发布也是真实的用户环境，所以可能出现问题，处理错误的理念是快速失败，启动式发现问题立即抛出异常。


#### 代码控制

代码进行版本管理，保证发布版本稳定正确，同时保证不同团队开发互不影响

1. 主干开发，分支发布

分支成为一个发布版本吗，如果发现bug，继续在该分支上修改发布，并合并到主干，直到下次发布

2. 分支开发，主干发布

任何修改不得在主干上进行，修改或者新增需要新建分支，直到测试通过再合并回主干


#### 自动化发布

发布前，多个代码分支合并回主干有可能导致冲突，预发布验证也会带来风险。

发布时间：周一-周三开发，周四发布，周五监控有情况返回

火车发布模型可以将发布自动化，发布做到无人值守。


#### 灰度发布

大型网站，一般是先发布一部分服务器，如果没有问题再全部发布完毕，这样只需要回滚一部分机器即可。

通过监控用户的行为以及体验报告，分为AB测试，确定最终的发布版本

![](../../image/gray.png)


### 网站运行监控

#### 监控数据采集

1. 用户行为日志收集

服务端日志收集（记录方便但是不一定是用户真实IP，无法识别访问路径）和客户端浏览器日志收集（需要嵌入代码，比较麻烦）

大型网站日志数据太多，需要设计实时计算框架进行日志分析和统计

2. 服务器性能监控

系统Load，内存占用，磁盘IO，网络IO

3. 运行数据报告

每分钟发送数据数目，待处理任务数，平均响应延迟时间，缓存命中率等

#### 监控管理

系统报警：指标异常时通过电话、邮件联系

失效转移：发现故障主动通知应用，进行失效转移

自动优雅降级：某些非核心功能进行优雅降级













